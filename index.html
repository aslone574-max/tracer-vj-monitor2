<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>TracerV.J â€” Final (Alert Â· Mute Â· Solid Risk Colors)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<style>
  :root{
    --bg:#0a0f14; --fg:#eaf2ff; --mut:#9fb1cf; --line:#1b2a3a; --brand:#6eb1ff;
    --ok:#16c784; --warn:#f59e0b; --bad:#ef4444; --glass:rgba(8,13,20,.65); --zoom:1.45;
    --mint:#16e0b1; --mintDark:#0aa082;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,'Noto Sans KR',sans-serif}
  #map{position:fixed; inset:0}

  /* ìƒë‹¨ ì¤‘ì•™ ê³ ì§€(ê²€ì€ ê¸€ìë§Œ) */
  .consent{
    position:fixed; left:50%; top:8px; transform:translateX(-50%) scale(var(--zoom));
    z-index:90; color:#000; font-weight:900; white-space:nowrap; letter-spacing:.2px; text-shadow:none;
  }

  /* ì¢Œìƒë‹¨ ë²„íŠ¼ ì¤„ */
  .top-left-row{position:fixed; left:8px; top:48px; z-index:80; display:flex; gap:8px; align-items:center;
                transform:scale(var(--zoom)); transform-origin:top left;}
  .iBtn{display:inline-flex; align-items:center; justify-content:center; gap:8px;
        border:1px solid var(--line); background:var(--glass); backdrop-filter:blur(6px);
        color:var(--fg); padding:8px 10px; border-radius:12px; font-weight:800; cursor:pointer;}
  .iBtn span{display:inline-block}

  /* ìš°ìƒë‹¨ ì¹© */
  .top-right{position:fixed; right:8px; top:48px; z-index:80; display:flex; gap:8px; align-items:center;
             transform:scale(var(--zoom)); transform-origin:top right;}
  .chip{border:1px solid var(--line); background:var(--glass); backdrop-filter:blur(6px);
        color:#cfe3ff; padding:6px 10px; border-radius:999px; display:inline-flex; gap:6px; align-items:center}
  .dot{width:8px;height:8px;border-radius:50%} .ok{background:var(--ok)} .warn{background:var(--warn)} .bad{background:var(--bad)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;opacity:.85}

  /* ë‚ ì”¨/ì‹œê³„ */
  .weatherbar{position:fixed; left:50%; top:100px; z-index:70; transform:translateX(-50%) scale(var(--zoom));
              transform-origin:top center; display:flex; flex-direction:column; align-items:center; gap:6px}
  .clock{border:1px solid var(--line);background:var(--glass);padding:4px 10px;border-radius:10px;color:#dfe9ff}
  .wxline{display:flex;gap:12px;align-items:center;border:1px solid var(--line);background:var(--glass);
          padding:6px 10px;border-radius:12px;white-space:nowrap}
  .wxitem{display:flex;gap:8px;align-items:center;font-weight:800}
  .wxsep{opacity:.5}
  .wxemoji{font-size:22px;line-height:1}

  /* ìš°ì¸¡ í†µê³„ */
  .stats{position:fixed; right:8px; top:168px; z-index:60; display:grid; gap:8px;
         transform:scale(var(--zoom)); transform-origin:top right;}
  .badge{border:1px solid var(--line); background:var(--glass); backdrop-filter:blur(6px);
         padding:8px 10px; border-radius:10px; min-width:180px; display:flex; justify-content:space-between; align-items:baseline}
  .badge .t{font-size:12px;color:var(--mut)}
  .badge .n{font-weight:900;font-size:18px; text-align:right; font-variant-numeric:tabular-nums}

  /* ìœ„í—˜ ì‚¬ê°í˜• (í´ë˜ìŠ¤ ê¸°ë°˜ ìƒ‰ ì „í™˜ ë³´ì¥) */
  .riskDock{
    position:fixed; right:8px; bottom:110px; z-index:80; min-width:272px;
    border-radius:16px; padding:16px 18px; border:1px solid #1a2532;
    box-shadow:0 10px 24px rgba(0,0,0,.35);
    transform:scale(var(--zoom)); transform-origin:bottom right;
    transition:background-color .25s, border-color .25s;
    background:#0b121b;
  }
  .risk-ok{ background:#0f3d2b !important; border-color:#0f3d2b !important; }
  .risk-warn{ background:#3a3008 !important; border-color:#3a3008 !important; }
  .risk-bad{ background:#3b0d0d !important; border-color:#3b0d0d !important; }
  .riskRow{display:flex; justify-content:space-between; align-items:center; margin:6px 0}
  .riskLabel{font-size:12px; color:#9fb2cf}
  .riskPct{font-weight:900; font-variant-numeric:tabular-nums}

  /* ìš°í•˜ë‹¨ ì‘ì€ ìƒìë“¤ */
  .right-below{position:fixed; right:8px; bottom:16px; z-index:75; display:flex; gap:8px;
               transform:scale(var(--zoom)); transform-origin:bottom right; align-items:center}
  .qbar{border:1px solid var(--line);background:var(--glass);padding:6px 10px;border-radius:10px;display:flex;gap:10px;align-items:center}
  .qpill{height:6px;width:52px;border-radius:999px;background:#233142;overflow:hidden;position:relative}
  .qfill{position:absolute;left:0;top:0;bottom:0;width:30%;background:var(--ok);transition:width .25s}
  .qtxt{font-size:12px;color:#b8c6dd}
  .bchip{border:1px solid var(--line);background:var(--glass);padding:6px 10px;border-radius:10px;display:flex;align-items:center;gap:8px}

  /* í•˜ë‹¨ ì¤‘ì•™ í†µí™” */
  .callFab{position:fixed; left:50%; bottom:16px; transform:translateX(-50%); z-index:85}
  .callFab button{width:72px;height:72px;border-radius:50%; border:2px solid #123a2a;
                  background:linear-gradient(180deg,#14b8a6,#0ea5e9); color:white;font-weight:900;font-size:16px;
                  box-shadow:0 12px 28px rgba(0,0,0,.45);}

  /* ë²”ë¡€ */
  .legend{position:fixed; left:8px; bottom:16px; z-index:70; display:grid; gap:6px;
          transform:scale(var(--zoom)); transform-origin:bottom left;}
  .legend .chip{padding:4px 8px}
  .lineKey{display:inline-block; width:24px; height:0; border-top:4px solid currentColor; vertical-align:middle; margin-right:6px}

  /* ì„¤ì • ë“œë¡œì–´ */
  .drawer{position:fixed; inset:0; display:none; z-index:95;} .drawer.open{display:block}
  .scrim{position:absolute; inset:0; background:rgba(0,0,0,.45)}
  .sheet{position:absolute; right:0; top:0; bottom:0; width:90vw; max-width:520px; background:#0f1620; border-left:1px solid var(--line); padding:14px; overflow:auto}
  .g{display:grid; gap:10px}
  input{border:1px solid var(--line); background:#0c1420; color:#eaf2ff; padding:10px 12px; border-radius:10px; font-size:16px}
  .groupTitle{font-weight:900;color:#cfe3ff;margin:4px 0 0 0}
  .sub{color:#9fb1cf;font-size:12px;margin-top:-4px}

  /* 100% ì „ì²´ ê²½ê³  ì˜¤ë²„ë ˆì´: ì¤‘ì•™ í° X + ìœ„ ë©”ì‹œì§€ + ì•„ë˜ ê°•ì œí•´ì œ */
  .alertFull{position:fixed; inset:0; z-index:200; display:none; align-items:center; justify-content:center;
             background:rgba(150,0,0,0.60); backdrop-filter:blur(2px); color:#fff; text-align:center}
  .alertFull.show{display:flex}
  .alertStack{display:flex; flex-direction:column; align-items:center; gap:14px}
  .alertMsg{font-size:22px; font-weight:900; text-shadow:0 2px 12px rgba(0,0,0,.6)}
  .alertClose{width:180px; height:180px; border-radius:50%; border:4px solid rgba(255,255,255,.9);
              background:rgba(0,0,0,.25); color:#fff; font-weight:900; font-size:108px; line-height:164px; cursor:pointer;
              box-shadow:0 10px 30px rgba(0,0,0,.45)}
  .alertClose:active{transform:scale(.97)}
  .alertMute{padding:10px 16px; border-radius:12px; border:2px solid rgba(255,255,255,.9);
             background:rgba(0,0,0,.25); color:#fff; font-weight:900; font-size:16px; cursor:pointer}

  /* ì‚¬ìš´ë“œ ì˜¨ ëª¨ë‹¬ */
  .soundModal{position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:210; display:flex; align-items:center; justify-content:center}
  .soundCard{background:#0e1520; border:1px solid var(--line); border-radius:16px; padding:18px; width:min(92vw,420px); text-align:center}
  .soundCard h3{margin:0 0 8px 0}
  .soundCard p{margin:0 0 12px 0; color:#bcd0ee}
  .soundCard button{width:100%; padding:12px 14px; border-radius:12px; border:1px solid #144; background:#0db; color:#012; font-weight:900; font-size:18px}

  /* í† ìŠ¤íŠ¸(ìš°ìƒë‹¨, ë¯¼íŠ¸/ê·¸ë¦°) */
  .toastWrap{position:fixed; right:10px; top:10px; z-index:220; display:flex; flex-direction:column; gap:8px}
  .toast{
    min-width:240px; max-width:320px; padding:10px 12px 10px 12px; border-radius:12px;
    background:linear-gradient(180deg, rgba(22,224,177,0.95), rgba(12,120,100,0.95));
    color:#012; border:1px solid rgba(5,60,50,0.6); box-shadow:0 10px 22px rgba(0,0,0,.28);
    font-weight:900; display:flex; align-items:flex-start; gap:8px;
  }
  .toast .tmsg{flex:1}
  .toast .tclose{cursor:pointer; font-weight:900; border:none; background:transparent; color:#022; font-size:18px; line-height:1}
  .toast .tsub{display:block; font-size:12px; font-weight:700; opacity:.8; margin-top:4px}

  .leaflet-container{font:12px/1.5 Arial,Helvetica,sans-serif} .leaflet-control-zoom{display:none}
</style>
</head>
<body>
<div id="map"></div>

<!-- ìƒë‹¨ ì¤‘ì•™ ì•ˆë‚´ -->
<div class="consent">í•´ë‹¹ ì–´í”Œì€ í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ì¶”ì ëŒ€ìƒì¸ ì–´ë¨¸ë‹ˆì˜ ë™ì˜ë¥¼ êµ¬í•œ ì¶”ì ì–´í”Œì…ë‹ˆë‹¤</div>

<!-- ì¢Œìƒë‹¨ ë²„íŠ¼ -->
<div class="top-left-row">
  <button id="btnMenu" class="iBtn" aria-label="menu"><span>â‰¡</span><span>ë©”ë‰´</span></button>
  <button id="btnZoomIn" class="iBtn" title="í™•ëŒ€"><span>ï¼‹</span></button>
  <button id="btnZoomOut" class="iBtn" title="ì¶•ì†Œ"><span>ï¼</span></button>
  <button id="btnCenter" class="iBtn" title="í˜„ìœ„ì¹˜"><span>í˜„ìœ„ì¹˜</span></button>
</div>

<!-- ìš°ìƒë‹¨ ì¹© -->
<div class="top-right">
  <div class="chip">D-<span id="trialLeft">1000</span></div>
  <div class="chip" id="serverChip"><span id="serverDot" class="dot warn"></span><span id="serverTxt">ë¯¸ì—°ê²°</span><span class="mono" id="chipPing">â€”</span></div>
  <button id="btnAudio" class="iBtn" style="font-weight:900">ğŸ”Š ì‚¬ìš´ë“œ OFF</button>
</div>

<!-- ë‚ ì”¨/ì‹œê³„ -->
<div class="weatherbar">
  <div class="clock" id="clock">â€”</div>
  <div class="wxline" id="wx">
    <div class="wxitem"><span>ì˜¤ëŠ˜ë‚ ì”¨</span><span id="wx0emoji" class="wxemoji">â˜€ï¸</span><span id="wx0t">â€”Â°C</span><span class="wxsep"> / </span><span id="wx0p" class="mono">â€”%</span></div>
    <div class="wxitem wxsep">|</div>
    <div class="wxitem"><span>ë‚´ì¼ë‚ ì”¨</span><span id="wx1emoji" class="wxemoji">â˜€ï¸</span><span id="wx1t">â€”Â°C</span><span class="wxsep"> / </span><span id="wx1p" class="mono">â€”%</span></div>
  </div>
</div>

<!-- ìš°ì¸¡ í†µê³„ -->
<div class="stats">
  <div class="badge"><div class="t">ê±°ë¦¬</div><div class="n" id="statDist">0.00 km</div></div>
  <div class="badge"><div class="t">ê±¸ìŒ</div><div class="n" id="statSteps">0</div></div>
  <div class="badge"><div class="t">ì‹œê°„</div><div class="n" id="statTime">0.0 ë¶„</div></div>
  <div class="badge"><div class="t">ì¹¼ë¡œë¦¬</div><div class="n" id="statKcal">0 kcal</div></div>
</div>

<!-- ìœ„í—˜ ì‚¬ê°í˜• -->
<div id="riskDock" class="riskDock risk-ok">
  <div class="riskRow"><span class="riskLabel">ë‚™ìƒ ìœ„í—˜</span><span id="fallPct" class="riskPct">0%</span></div>
  <div class="riskRow"><span class="riskLabel">ìœ„ì¹˜ ìœ„í—˜</span><span id="locPct" class="riskPct">0%</span></div>
</div>

<!-- ìš°í•˜ë‹¨ ì‘ì€ ìƒì -->
<div class="right-below">
  <div class="qbar" title="ì—°ê²°/ì •í™•ë„">
    <span class="qtxt">ğŸ“¶</span><span class="qpill"><span id="qNet" class="qfill" style="width:20%"></span></span>
    <span class="qtxt">ğŸ¯</span><span class="qpill"><span id="qAcc" class="qfill" style="width:20%"></span></span>
  </div>
  <div class="bchip" id="bchip">ğŸ”‹ â€”%</div>
</div>

<!-- í•˜ë‹¨ ì¤‘ì•™ í†µí™” -->
<div class="callFab"><button id="btnCall" title="ëŒ€ìƒìì—ê²Œ ì „í™”">ğŸ“</button></div>

<!-- ë²”ë¡€ -->
<div class="legend">
  <div class="chip"><span class="lineKey" style="color:#6eb1ff"></span>ì˜¤ëŠ˜ ê²½ë¡œ</div>
  <div class="chip"><span class="lineKey" style="color:#00ffff; opacity:.35"></span>ìµœê·¼ 7ì¼</div>
  <div class="chip"><span class="lineKey" style="color:#b07cff; opacity:.25"></span>ìµœê·¼ 15ì¼</div>
  <div class="chip"><span class="lineKey" style="color:#b8c2d6; opacity:.18"></span>ìµœê·¼ 30ì¼</div>
</div>

<!-- 100% ì „ì²´ ê²½ê³  (ë©”ì‹œì§€ ìœ„, X ì¤‘ì•™, ê°•ì œí•´ì œ ì•„ë˜) -->
<div id="alertFull" class="alertFull" aria-hidden="true" role="alertdialog" aria-label="ìœ„í—˜ ê²½ê³ ">
  <div class="alertStack">
    <div id="alertMsg" class="alertMsg">ìœ„í—˜! ë‚™ìƒ/ìœ„ì¹˜ ìœ„í—˜ 100%</div>
    <button id="alertClose" class="alertClose" aria-label="ë‹«ê¸°">âœ•</button>
    <button id="alertMute" class="alertMute" aria-label="ê°•ì œ í•´ì œ">ê°•ì œ í•´ì œ (2ë¶„ê°„ ì¬ì•Œë¦¼ ì°¨ë‹¨)</button>
  </div>
</div>

<!-- ì„¤ì • ë“œë¡œì–´ -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="scrim" id="scrim"></div>
  <div class="sheet g" role="dialog" aria-label="ì„¤ì •/ì‹ë³„/ê³µìœ ">
    <h3 class="groupTitle">ì—­í• /ì‹ë³„(ê³µê¸°ê³„ ì§€ì›)</h3>
    <div class="sub">ğŸ“ ë²„íŠ¼ì€ <b>ëŒ€ìƒì ë²ˆí˜¸</b>ë¡œ ë°œì‹ . ëª¨ë“  ê°’ì€ ë¡œì»¬(localStorage)ì— ì €ì¥ë©ë‹ˆë‹¤.</div>
    <div class="g">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div class="sub">ëŒ€ìƒì ì „í™”ë²ˆí˜¸</div><input id="inpPhoneTarget" placeholder="ì˜ˆ: 01012345678" inputmode="tel"></div>
        <div><div class="sub">ë³´í˜¸ì(ê´€ë¦¬ì) ë²ˆí˜¸</div><input id="inpPhoneGuardian" placeholder="ì˜ˆ: 01098765432" inputmode="tel"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div class="sub">ëŒ€ìƒì ê¸°ê¸°ID</div><input id="inpDevTarget" placeholder="ì˜ˆ: target-uuid"></div>
        <div><div class="sub">ë³´í˜¸ì ê¸°ê¸°ID</div><input id="inpDevGuardian" placeholder="ì˜ˆ: guardian-uuid"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="iBtn" id="btnSaveIDs">ì €ì¥</button>
        <button class="iBtn" id="btnGenIDs">ë¬´ì‘ìœ„ ID ìƒì„±</button>
      </div>
    </div>
    <h3 class="groupTitle">ì„œë²„/ê¸°ë³¸</h3>
    <div class="g">
      <div class="sub">ì„œë²„ URL (ì„ íƒ, ìˆìœ¼ë©´ ì›ê²© ëª¨ë‹ˆí„°ë§)</div>
      <div style="display:flex;gap:8px"><input id="inpUrl" placeholder="https://example.run.app" style="flex:1"><button class="iBtn" id="btnSaveUrl">ì €ì¥</button></div>
    </div>
    <h3 class="groupTitle">ê³µìœ (ì½ê¸°ì „ìš©)</h3>
    <div class="g"><button class="iBtn" id="btnShare">ì½ê¸°ì „ìš© ë§í¬ ë³µì‚¬</button></div>
  </div>
</div>

<!-- ì‚¬ìš´ë“œ ì˜¨ ëª¨ë‹¬ -->
<div id="soundModal" class="soundModal">
  <div class="soundCard">
    <h3>ğŸ”Š ì•ˆì „ ì•Œë¦¼ì„ ì¼­ë‹ˆë‹¤</h3>
    <p>ë¸Œë¼ìš°ì € ì •ì±…ìœ¼ë¡œ ì¸í•´ ì²« íƒ­ì´ í•„ìš”í•©ë‹ˆë‹¤. <b>ì‚¬ìš´ë“œ ON</b>ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
    <button id="soundGo">ì‚¬ìš´ë“œ ON</button>
  </div>
</div>

<!-- ìš°ìƒë‹¨ í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
<div id="toastWrap" class="toastWrap" aria-live="polite" aria-atomic="true"></div>

<script type="module">
const $=s=>document.querySelector(s);

/* ===== ì„¤ì • ìƒìˆ˜ ===== */
const TRIAL_MS = 1000*24*3600*1000;        // 1000ì¼
const FALL_POST_MS = 20000;                 // ë‚™ìƒ í™•ì • 20ì´ˆ
const CJ_CENTER=[36.634,127.497];

/* ===== ìƒíƒœ ===== */
let baseUrl = localStorage.getItem('ag.serverUrl') || '';
let phoneTarget = localStorage.getItem('ag.phone.target') || '';
let phoneGuardian = localStorage.getItem('ag.phone.guard') || '';
let devTarget = localStorage.getItem('ag.dev.target') || '';
let devGuardian = localStorage.getItem('ag.dev.guard') || '';

/* ===== ì§€ë„ ===== */
const map=L.map('map',{zoomControl:false}).setView(CJ_CENTER,14);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Â© OSM'}).addTo(map);
const marker=L.marker(CJ_CENTER).addTo(map);
const circle=L.circle(CJ_CENTER,{radius:12,color:'#6eb1ff',fillColor:'#6eb1ff',fillOpacity:.15}).addTo(map);
const todayLine=L.polyline([], {color:'#6eb1ff', weight:5, opacity:0.9}).addTo(map);
const weekLine =L.polyline([], {color:'#00ffff', weight:4, opacity:0.35}).addTo(map);
const d15Line  =L.polyline([], {color:'#b07cff', weight:4, opacity:0.25}).addTo(map);
const d30Line  =L.polyline([], {color:'#b8c2d6', weight:4, opacity:0.18}).addTo(map);

/* ===== í†µê³„ ===== */
const statDist=$('#statDist'), statSteps=$('#statSteps'), statTime=$('#statTime'), statKcal=$('#statKcal');
const toRad=d=>d*Math.PI/180;
const hav=(a,b,c,d)=>{const R=6371000, dLat=toRad(c-a), dLon=toRad(d-b), x=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));};
const stride=()=>0.7;
const kcalK1=(km,kg)=>(!kg||!km)?0:kg*km;
const kcalK2=(min,kg,met=3.3)=>(!kg||!min)?0:met*3.5*kg*min/200;
const profile={mode: localStorage.getItem('ag.prefMode') || 'K1',
               kg: Number(localStorage.getItem('ag.weightKg')||0)||0,
               cm: Number(localStorage.getItem('ag.heightCm')||0)||0};
function renderStatsFrom(pts){
  if(pts.length<2){ statDist.textContent='0.00 km'; statSteps.textContent='0'; statTime.textContent='0.0 ë¶„'; statKcal.textContent='0 kcal'; return; }
  let dist=0; for(let i=1;i<pts.length;i++){ const A=pts[i-1], B=pts[i]; const q=(A.acc>30||B.acc>30)?0.5:1.0; dist+=hav(A.lat,A.lon,B.lat,B.lon)*q; }
  const km=dist/1000, tmin=(pts.at(-1).ts - pts[0].ts)/60000, steps=Math.round(dist/stride());
  const kcal=(profile.mode==='K2'&&profile.kg>0)?kcalK2(tmin,profile.kg):kcalK1(km,profile.kg);
  statDist.textContent=km.toFixed(2)+' km'; statSteps.textContent=String(steps); statTime.textContent=tmin.toFixed(1)+' ë¶„'; statKcal.textContent=kcal.toFixed(0)+' kcal';
}

/* ===== ìœ„í—˜ ì‚¬ê°í˜• (í´ë˜ìŠ¤ ê¸°ë°˜ ì „í™˜) ===== */
const riskDock=$('#riskDock'), fallEl=$('#fallPct'), locEl=$('#locPct'), alertFull=$('#alertFull'), alertMsg=$('#alertMsg');
let _wasFull=false;
let muteUntil=0;      // ê°•ì œí•´ì œ ì‹œê°ê¹Œì§€ ì¬ì•ŒëŒ ì°¨ë‹¨
function applyRiskClass(v){
  riskDock.classList.remove('risk-ok','risk-warn','risk-bad');
  if(v<40) riskDock.classList.add('risk-ok');
  else if(v<70) riskDock.classList.add('risk-warn');
  else riskDock.classList.add('risk-bad');
}
function showAlertFull(message='ìœ„í—˜! ë‚™ìƒ/ìœ„ì¹˜ ìœ„í—˜ 100%'){
  alertMsg.textContent = message;
  alertFull.classList.add('show'); alertFull.setAttribute('aria-hidden','false');
  try{ navigator.vibrate && navigator.vibrate([150,150,300,150,600]); }catch(e){}
  alarmFallStart();
  showToast(message, 'danger');
}
function hideAlertFull(){
  alertFull.classList.remove('show'); alertFull.setAttribute('aria-hidden','true');
  _wasFull=false; stopFallAlarm();
}
function updateRisk(fallPct,locPct){
  const f=Math.max(0,Math.min(100,Math.round(fallPct||0)));
  const l=Math.max(0,Math.min(100,Math.round(locPct ||0)));
  fallEl.textContent=f+'%'; locEl.textContent=l+'%';
  const worst=Math.max(f,l);
  applyRiskClass(worst);               // â† ìƒ‰ìƒ ì „í™˜ í™•ì‹¤íˆ ì ìš©
  // ì•ŒëŒ/ì˜¤ë²„ë ˆì´
  const now=Date.now();
  if(worst>=100 && !_wasFull && now>=muteUntil){ showAlertFull(); _wasFull=true; }
  if(worst<100 && _wasFull){ hideAlertFull(); }
  if (worst >= 70 && worst < 100 && now>=muteUntil) { chirpWarn(); showToast('ìœ„í—˜ ìƒìŠ¹ (ë…¸ë€ êµ¬ê°„)', 'warn'); }
}

/* ===== ê²½ë¡œ/ë£¨í‹´/ìì • ë¡¤ì˜¤ë²„ ===== */
const dateKey=(ts=Date.now())=>{ const d=new Date(ts); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
const loadTracks=()=>{ try{return JSON.parse(localStorage.getItem('ag.tracks')||'[]');}catch{return [];} };
const saveTracks=arr=>localStorage.setItem('ag.tracks', JSON.stringify(arr));
function pushTodayPoint(lat,lon,acc,ts){
  const key=dateKey(ts); const tracks=loadTracks(); let t=tracks.find(x=>x.day===key);
  if(!t){ t={day:key,pts:[]}; tracks.push(t); } t.pts.push({lat,lon,ts,acc}); saveTracks(tracks);
}
const pointsToLatLngs=pts=>pts.map(p=>[p.lat,p.lon]);
function cutDays(days){ const now=Date.now(), ms=days*24*3600*1000; const tracks=loadTracks().filter(t=>(now-new Date(t.day+'T00:00:00').getTime())<=ms); return pointsToLatLngs(tracks.flatMap(t=>t.pts)); }
function redrawAggregates(){
  const b7=weekLine.getLatLngs().length, b15=d15Line.getLatLngs().length, b30=d30Line.getLatLngs().length;
  const s7=cutDays(7), s15=cutDays(15), s30=cutDays(30);
  weekLine.setLatLngs(s7); d15Line.setLatLngs(s15); d30Line.setLatLngs(s30);
  if(audioOn){
    if(!b7 && s7.length) jingleAggregateMilestone(7), showToast('ìµœê·¼ 7ì¼ ëˆ„ì  ê²½ë¡œ ì—…ë°ì´íŠ¸', 'ok');
    if(!b15 && s15.length) jingleAggregateMilestone(15), showToast('ìµœê·¼ 15ì¼ ëˆ„ì  ê²½ë¡œ ì—…ë°ì´íŠ¸', 'ok');
    if(!b30 && s30.length) jingleAggregateMilestone(30), showToast('ìµœê·¼ 30ì¼ ëˆ„ì  ê²½ë¡œ ì—…ë°ì´íŠ¸', 'ok');
  }
}
function scheduleMidnightRoll(){
  const now=new Date(); const next=new Date(now); next.setHours(24,0,0,0);
  setTimeout(()=>{
    const worst=parseInt(fallEl.textContent)||0;
    if(worst<70){ jingleAllClear(); showToast('í•˜ë£¨ ì¢…ë£Œ: ì´ìƒ ë¬´(ALL CLEAR)', 'ok'); }
    jingleRoutineComplete(); showToast('ë£¨í‹´ ì¢…ê²°: ì˜¤ëŠ˜ ê¶¤ì  ë¦¬ì…‹', 'ok');
    todayLine.setLatLngs([]); _lastPos=null;
    scheduleMidnightRoll();
  }, next.getTime()-now.getTime());
}

/* ===== WS / ì‹ í˜¸ / ë°°í„°ë¦¬ ===== */
const serverTxt=$('#serverTxt'), serverDot=$('#serverDot'), chipPing=$('#chipPing');
let ws=null;
function setNetQuality(pct){ const el=$('#qNet'); el.style.width=pct+'%'; el.style.background = pct>=66?'#16c784':(pct>=33?'#f59e0b':'#ef4444'); }
function setAccQuality(acc){ const pct= acc<=8?100 : acc<=20?60 : 25; const el=$('#qAcc'); el.style.width=pct+'%'; el.style.background = pct>=66?'#16c784':(pct>=33?'#f59e0b':'#ef4444'); }
function connectWS(){
  if(!baseUrl){ serverTxt.textContent='URL í•„ìš”'; serverDot.className='dot bad'; setNetQuality(20); return; }
  const url = baseUrl.replace('https','wss').replace('http','ws') + '/ws/track';
  const t0=performance.now(); ws=new WebSocket(url);
  ws.onopen=()=>{ serverTxt.textContent='ì—°ê²°'; serverDot.className='dot ok'; chipPing.textContent=Math.round(performance.now()-t0)+'ms'; setNetQuality(100); jingleConnect(); showToast('ì„œë²„ ì—°ê²° ì™„ë£Œ', 'ok'); };
  ws.onclose=()=>{ serverTxt.textContent='ëŠê¹€'; serverDot.className='dot warn'; setNetQuality(40); jingleDisconnect(); showToast('ì„œë²„ ì—°ê²° ëŠê¹€', 'warn'); setTimeout(connectWS,1500); };
  ws.onerror=()=>{ serverTxt.textContent='ì˜¤ë¥˜'; serverDot.className='dot bad'; setNetQuality(20); jingleDisconnect(); showToast('ì„œë²„ ì˜¤ë¥˜', 'warn'); };
  ws.onmessage=(ev)=>{ try{ const m=JSON.parse(ev.data); if(m.type==='risk') updateRisk(m.fallPct,m.locPct); }catch(_){} };
}
async function batteryGuard(){
  try{
    if(!navigator.getBattery){ $('#bchip').textContent='ğŸ”‹ N/A'; return; }
    const b=await navigator.getBattery();
    const upd=()=>{ const pct=Math.round(b.level*100); $('#bchip').textContent=(b.charging?'ğŸ”Œ ':'ğŸ”‹ ')+pct+'%'; };
    b.addEventListener('levelchange',upd); b.addEventListener('chargingchange',upd); upd();
  }catch{ $('#bchip').textContent='ğŸ”‹ N/A'; }
}

/* ===== ì²´ë¥˜ ì¦ê²¨ì°¾ê¸°(1ì‹œê°„) ===== */
let _todayPoints=[], _cooldownMs=0, _lastPushTs=0;
const starIcon=new L.DivIcon({className:'', html:'<div style="color:#ffd54f;font-size:22px;filter:drop-shadow(0 2px 4px rgba(0,0,0,.6))">â˜…</div>', iconSize:[22,22], iconAnchor:[11,11]});
let dwellStart=null, lastStarLat=null, lastStarLon=null;
function maybeAddFavorite(lat,lon){
  const R=40; if(!dwellStart){ dwellStart={lat,lon,ts:Date.now()}; return; }
  const d=hav(dwellStart.lat,dwellStart.lon,lat,lon);
  if(d<=R){
    const stay=(Date.now()-dwellStart.ts)/60000;
    if(stay>=60){
      if(!lastStarLat||hav(lastStarLat,lastStarLon,lat,lon)>60){
        L.marker([lat,lon],{icon:starIcon}).addTo(map).bindTooltip('ì¦ê²¨ì°¾ê¸°(ì²´ë¥˜ 1ì‹œê°„+)',{permanent:false});
        lastStarLat=lat; lastStarLon=lon;
        showToast('ì¦ê²¨ì°¾ê¸°(ì²´ë¥˜ 1ì‹œê°„) ìë™ ìƒì„±', 'ok');
      }
    }
  } else { dwellStart={lat,lon,ts:Date.now()}; }
}

/* ===== ìœ„ì¹˜ í‘¸ì‹œ ===== */
function pushPos(lat,lon,acc=10){
  const now=Date.now(); if(_cooldownMs && (_lastPushTs && now-_lastPushTs<_cooldownMs)) return; _lastPushTs=now;
  const ts=now, latlng=[lat,lon];
  todayLine.addLatLng(latlng); marker.setLatLng(latlng); circle.setLatLng(latlng);
  _todayPoints.push({lat,lon,ts,acc}); renderStatsFrom(_todayPoints);
  gpsJerkUpdate(lat,lon,acc,ts); setAccQuality(acc); maybeAddFavorite(lat,lon);
  pushTodayPoint(lat,lon,acc,ts); redrawAggregates();
  if(ws&&ws.readyState===1){
    const did=devTarget || (localStorage.getItem('ag.did')||(crypto.randomUUID?.()||String(Math.random())));
    localStorage.setItem('ag.did',did);
    ws.send(JSON.stringify({type:'up',deviceId:did,geo:{lat,lon,acc},ts}));
  }
}
function startGeo(){
  if(navigator.geolocation){
    try{
      navigator.geolocation.watchPosition(
        pos=>{ const {latitude,longitude,accuracy}=pos.coords; const acc=Math.max(5,Math.round(accuracy||10)); pushPos(latitude,longitude,acc); },
        _=>fallbackDemo(), {enableHighAccuracy:true,maximumAge:1000,timeout:5000}
      ); return;
    }catch{}
  }
  fallbackDemo();
}
function fallbackDemo(){
  const path=[[36.6288,127.4965],[36.6316,127.4989],[36.6347,127.5003],[36.6371,127.4981],[36.6389,127.4940],[36.6373,127.4900],[36.6342,127.4907],[36.6311,127.4930]];
  let i=0; setInterval(()=>{ const [a,b]=path[i%path.length]; i++; pushPos(a,b,10); map.panTo([a,b],{animate:true}); },3000);
}

/* ===== ë‚™ìƒ FSM + GPS Jerk ===== */
const G=9.81; let fsm='IDLE', preTs=0, impTs=0, postStart=0, postBuffer=[];
function mag(a){ return Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z); }
function nowMs(){ return performance.now(); }
function checkPostImmobility(){ if(postBuffer.length<15) return false; const m=postBuffer; const avg=m.reduce((s,v)=>s+v,0)/m.length; const varc=m.reduce((s,v)=>s+(v-avg)*(v-avg),0)/m.length; return avg>0.6 && avg<1.4 && varc<0.02; }
function attachMotion(){
  window.addEventListener('devicemotion', (ev)=>{
    const a=ev.accelerationIncludingGravity; if(!a) return;
    const g=mag(a)/G; const t=nowMs();
    if(fsm==='IDLE'){ if(g<0.2){ fsm='PRE'; preTs=t; } }
    else if(fsm==='PRE'){ if(g>2.5){ fsm='IMPACT'; impTs=t; postBuffer.length=0; postStart=0; } else if(t-preTs>800){ fsm='IDLE'; } }
    else if(fsm==='IMPACT'){
      postBuffer.push(g); if(postBuffer.length>30) postBuffer.shift();
      if(!postStart) postStart=t;
      if(checkPostImmobility() && (t-postStart)>20000){ if(Date.now()>=muteUntil){ fsm='FALL'; updateRisk(100, Math.max(parseInt($('#locPct').textContent)||0, 70)); showAlertFull(); } }
      if(t-impTs>6000 && !checkPostImmobility()){ fsm='IDLE'; postBuffer.length=0; }
    }else if(fsm==='FALL'){ if(g>1.4){ fsm='IDLE'; postBuffer.length=0; hideAlertFull(); } }
    let simFall=0; if(fsm==='PRE') simFall=30; else if(fsm==='IMPACT') simFall=70; else if(fsm==='FALL') simFall=100;
    const curLoc=parseInt($('#locPct').textContent)||0; if(simFall>0) updateRisk(simFall,curLoc);
  }, {capture:false});
}
let _gpsPrev=null;
function gpsJerkUpdate(lat,lon,acc,ts){
  if(!_gpsPrev){ _gpsPrev={lat,lon,ts,speed:0}; return; }
  const dt=(ts-_gpsPrev.ts)/1000, dLat=(lat-_gpsPrev.lat)*111320, dLon=(lon-_gpsPrev.lon)*88000;
  const speed=Math.sqrt(dLat*dLat+dLon*dLon)/(dt||1), jerk=Math.abs(speed-(_gpsPrev.speed||0));
  _gpsPrev={lat,lon,ts,speed};
  const fallRisk=Math.min(100,Math.max(0,(jerk-1.5)*30));
  const locRisk =Math.min(100,Math.max(0,(acc-10)*3));
  updateRisk(fallRisk,locRisk);
}

/* ===== ì‹œê³„/ë‚ ì”¨ ===== */
function startClock(){
  const el=$('#clock'); const dnames=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const tick=()=>{const d=new Date();el.textContent=`${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} (${dnames[d.getDay()]})  ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`};
  tick(); setInterval(tick,30000);
}
function emojiKey(weatherCode, precipProb, cloud){ if (weatherCode >= 95 || precipProb >= 70) return 'â›ˆï¸'; if (precipProb >= 40) return 'ğŸŒ§ï¸'; if (cloud >= 60) return 'â˜ï¸'; return 'â˜€ï¸'; }
async function loadWeather(lat,lon){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=cloudcover,precipitation_probability&daily=temperature_2m_max,precipitation_probability_max,weathercode&timezone=auto`;
    const r=await fetch(url); const j=await r.json();
    const t0=Math.round(j.daily.temperature_2m_max[0]), p0=j.daily.precipitation_probability_max[0]??0, w0=j.daily.weathercode[0]??0;
    const t1=Math.round(j.daily.temperature_2m_max[1]), p1=j.daily.precipitation_probability_max[1]??0, w1=j.daily.weathercode[1]??0;
    const cc=j.hourly.cloudcover?.[0] ?? 0;
    $('#wx0emoji').textContent = emojiKey(w0,p0,cc);
    $('#wx1emoji').textContent = emojiKey(w1,p1,cc);
    $('#wx0t').textContent = `${t0}Â°C`; $('#wx0p').textContent = `${p0}%`;
    $('#wx1t').textContent = `${t1}Â°C`; $('#wx1p').textContent = `${p1}%`;
  }catch{
    $('#wx0emoji').textContent='â€”'; $('#wx1emoji').textContent='â€”';
    $('#wx0t').textContent = `N/A`; $('#wx0p').textContent = `â€”%`;
    $('#wx1t').textContent = `N/A`; $('#wx1p').textContent = `â€”%`;
  }
}

/* ===== ê³µìœ  ë§í¬ ===== */
function buildShareLink(){
  const day=dateKey(); const t=loadTracks().find(x=>x.day===day);
  const data={day,pts:t?t.pts.map(p=>[Number(p.lat.toFixed(5)),Number(p.lon.toFixed(5))]):[], target:devTarget, guardian:devGuardian};
  const raw=btoa(unescape(encodeURIComponent(JSON.stringify(data))));
  const token=Math.floor(Date.now()/1000+24*3600);
  const url=location.origin+location.pathname+`?view=ro&d=${raw}&exp=${token}`;
  navigator.clipboard?.writeText(url); showToast('ì½ê¸°ì „ìš© ë§í¬ ë³µì‚¬ë¨(24h)', 'ok');
}

/* ===== R2-D2 ì‚¬ìš´ë“œ & í† ìŠ¤íŠ¸ ===== */
let audioCtx=null, audioOn=false, fallAlarmTimer=null;
function audioUnlock(){
  if(audioOn) return;
  try{
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    audioOn = true;
    $('#btnAudio').textContent = 'ğŸ”Š ì‚¬ìš´ë“œ ON';
    beep([{f:880,d:80},{f:1320,d:80},{f:1760,d:80}]);
    $('#soundModal').style.display='none';
    showToast('ì‚¬ìš´ë“œ ON', 'ok');
  }catch(e){ alert('ì˜¤ë””ì˜¤ ì´ˆê¸°í™” ì‹¤íŒ¨: '+e); }
}
function makeOsc(f,d, type='sine',gain=0.12, when=0){
  const o = audioCtx.createOscillator(), g = audioCtx.createGain();
  o.type = type; o.frequency.value = f;
  g.gain.setValueAtTime(0, audioCtx.currentTime+when);
  g.gain.linearRampToValueAtTime(gain, audioCtx.currentTime+when+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+when + d/1000);
  o.connect(g).connect(audioCtx.destination);
  o.start(audioCtx.currentTime+when);
  o.stop(audioCtx.currentTime+when + d/1000 + 0.02);
  return d;
}
function beep(seq){ if(!audioOn || !audioCtx) return; let t=0; for(const s of seq){ t += makeOsc(s.f, s.d, s.type||'sine', s.gain||0.12, t/1000); t += s.gap||20; } }
function jingleConnect(){ beep([{f:880,d:90},{f:1175,d:90},{f:1660,d:120}]); }
function jingleDisconnect(){ beep([{f:440,d:120},{f:330,d:120},{f:220,d:180}]); }
function chirpWarn(){ beep([{f:1200,d:60, type:'triangle', gain:0.10}]); }
function alarmFallStart(){ stopFallAlarm(); const loop=()=>{ beep([{f:880,d:120,type:'square',gain:0.14},{f:660,d:120,type:'square',gain:0.14,gap:40},{f:990,d:160,type:'square',gain:0.14}]); fallAlarmTimer = setTimeout(loop, 900); }; loop(); }
function stopFallAlarm(){ if(fallAlarmTimer){ clearTimeout(fallAlarmTimer); fallAlarmTimer=null; } }
function jingleRoutineComplete(){ beep([{f:1046,d:120},{f:1318,d:120},{f:1567,d:160}]); }
function jingleAggregateMilestone(days){ const base = days===7?880:days===15?988:1108; beep([{f:base,d:90},{f:base+220,d:120}]); }
function jingleAllClear(){ beep([{f:660,d:80},{f:880,d:80},{f:660,d:80}]); }

function showToast(msg, level='ok'){
  const wrap=$('#toastWrap');
  const el=document.createElement('div');
  el.className='toast';
  el.innerHTML=`<div class="tmsg">${msg}<span class="tsub">${level==='ok'?'ì •ìƒ ì•Œë¦¼': level==='warn'?'ì£¼ì˜ ì•Œë¦¼':'ì¤‘ìš” ì•Œë¦¼'}</span></div><button class="tclose" aria-label="ë‹«ê¸°">âœ•</button>`;
  const closer=()=>{ el.remove(); };
  el.querySelector('.tclose').onclick=closer;
  wrap.appendChild(el);
  setTimeout(()=>{ try{el.remove();}catch{} }, 10000);
}

/* ===== UI ì—°ë™ ===== */
const trialLeftEl=$('#trialLeft'), drawer=$('#drawer'), scrim=$('#scrim');
const inpUrl=$('#inpUrl'); const inpPhoneTarget=$('#inpPhoneTarget'), inpPhoneGuardian=$('#inpPhoneGuardian');
const inpDevTarget=$('#inpDevTarget'),   inpDevGuardian=$('#inpDevGuardian');
$('#btnMenu').onclick=()=>{ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false');
  inpUrl.value=baseUrl||''; inpPhoneTarget.value=phoneTarget||''; inpPhoneGuardian.value=phoneGuardian||'';
  inpDevTarget.value=devTarget||''; inpDevGuardian.value=devGuardian||''; };
scrim.onclick=()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); };
$('#btnSaveUrl').onclick=()=>{ baseUrl=inpUrl.value.trim(); localStorage.setItem('ag.serverUrl',baseUrl); drawer.classList.remove('open'); if(baseUrl){ connectWS(); showToast('ì„œë²„ URL ì €ì¥', 'ok'); } };
$('#btnSaveIDs').onclick=()=>{ phoneTarget=inpPhoneTarget.value.replace(/\D/g,''); localStorage.setItem('ag.phone.target',phoneTarget);
  phoneGuardian=inpPhoneGuardian.value.replace(/\D/g,''); localStorage.setItem('ag.phone.guard',phoneGuardian);
  devTarget=inpDevTarget.value.trim(); if(!devTarget) devTarget=crypto.randomUUID?.()||String(Math.random()); localStorage.setItem('ag.dev.target',devTarget);
  devGuardian=inpDevGuardian.value.trim(); if(!devGuardian) devGuardian=crypto.randomUUID?.()||String(Math.random()); localStorage.setItem('ag.dev.guard',devGuardian);
  drawer.classList.remove('open'); showToast('ì‹ë³„/ì—°ë½ì²˜ ì €ì¥', 'ok'); };
$('#btnGenIDs').onclick=()=>{ inpDevTarget.value=crypto.randomUUID?.()||('t-'+Math.random()); inpDevGuardian.value=crypto.randomUUID?.()||('g-'+Math.random()); };
$('#btnShare').onclick=buildShareLink;
$('#btnCenter').onclick=()=>{ const p=_todayPoints.length?_todayPoints.at(-1):null; const latlng=p?[p.lat,p.lon]:(marker? [marker.getLatLng().lat,marker.getLatLng().lng]:map.getCenter()); map.setView(latlng, Math.max(map.getZoom(),16), {animate:true}); };
$('#btnZoomIn').onclick=()=>map.setZoom(map.getZoom()+1);
$('#btnZoomOut').onclick=()=>map.setZoom(map.getZoom()-1);
$('#btnCall').onclick=()=>{ if(!phoneTarget){ showToast('ëŒ€ìƒì ë²ˆí˜¸ë¥¼ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”', 'warn'); return; } location.href=`tel:${phoneTarget}`; };

function setTrialFrom(ts){ const dleft=Math.max(0,Math.floor((TRIAL_MS-(Date.now()-ts))/(24*3600*1000))); trialLeftEl.textContent=String(dleft); }
function redrawAggregatesBoot(){ weekLine.setLatLngs(cutDays(7)); d15Line.setLatLngs(cutDays(15)); d30Line.setLatLngs(cutDays(30)); }
function loadTodayBoot(){ const day=dateKey(); const t=loadTracks().find(x=>x.day===day); if(t){ window._todayPoints=t.pts.slice(); todayLine.setLatLngs(t.pts.map(p=>[p.lat,p.lon])); renderStatsFrom(window._todayPoints); } }

/* ===== ê°•ì œ í•´ì œ ë²„íŠ¼ ===== */
$('#alertClose').addEventListener('click', ()=> hideAlertFull());
$('#alertMute').addEventListener('click', ()=>{
  muteUntil = Date.now() + 2*60*1000;  // 2ë¶„ ì°¨ë‹¨
  stopFallAlarm(); hideAlertFull();
  showToast('ê°•ì œ í•´ì œ: 2ë¶„ê°„ ì¬ì•Œë¦¼ ì°¨ë‹¨', 'warn');
});

/* ===== ë¶€íŒ… ===== */
(function boot(){
  setTrialFrom(Number(localStorage.getItem('ag.lastOkTs')||Date.now()));

  // ì‹œê³„/ë‚ ì”¨
  startClock();
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos=>loadWeather(pos.coords.latitude,pos.coords.longitude),
      _=>loadWeather(CJ_CENTER[0],CJ_CENTER[1]),
      {maximumAge:60000,timeout:4000}
    );
  } else { loadWeather(CJ_CENTER[0],CJ_CENTER[1]); }

  batteryGuard(); redrawAggregatesBoot(); loadTodayBoot(); scheduleMidnightRoll();
  startGeo();
  if(baseUrl) connectWS();

  try{
    if(typeof DeviceMotionEvent==='function' && DeviceMotionEvent.requestPermission){
      DeviceMotionEvent.requestPermission().then(p=>{ if(p==='granted') attachMotion(); });
    }else{ attachMotion(); }
  }catch{}

  // ì‚¬ìš´ë“œ ì˜¨
  $('#btnAudio').addEventListener('click', ()=>{ if(!audioOn) audioUnlock(); else{ audioOn=false; try{ audioCtx && audioCtx.suspend(); }catch{} $('#btnAudio').textContent='ğŸ”‡ ì‚¬ìš´ë“œ OFF'; showToast('ì‚¬ìš´ë“œ OFF', 'warn'); } });
  $('#soundGo').addEventListener('click', audioUnlock);
  window.addEventListener('touchstart', ()=>{ if(!audioOn) audioUnlock(); }, {once:true});

  // PC/ëª¨ë‹ˆí„°ë§ì—ì„œ ì‹œì‘ ì‹œ ìœ„í—˜ 0ìœ¼ë¡œ ë¦¬ì…‹
  const isTouch = ('ontouchstart' in window) || navigator.maxTouchPoints>0;
  if(!isTouch){ updateRisk(0,0); hideAlertFull(); }

  showToast('ì¤€ë¹„ ì™„ë£Œ', 'ok');
})();
</script>
</body>
</html>
